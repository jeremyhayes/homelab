version: 1

metadata:
  name: OIDC Immich

entries:

  - model: authentik_providers_oauth2.oauth2provider
    id: immich
    identifiers:
      name: Provider for Immich
    attrs:
      authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
      invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
      client_id: !File /run/secrets/immich-client-id
      client_secret: !File /run/secrets/immich-client-secret
      redirect_uris:
        - matching_mode: strict
          url: https://immich.lab.omglolwtfbbq.com/auth/login
        - matching_mode: strict
          url: https://immich.lab.omglolwtfbbq.com/user-settings
        - matching_mode: strict
          url: app.immich:///oauth-callback
      signing_key: !Find [authentik_crypto.certificatekeypair, [name, authentik Self-signed Certificate]]
      sub_mode: user_username
      access_token_validity: "minutes=5"
      property_mappings:
        - !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-openid]]
        - !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-email]]
        - !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-profile]]

  - model: authentik_core.application
    identifiers:
      slug: immich
    attrs:
      name: Immich
      provider: !KeyOf immich
      group: Applications
      icon: icons/immich.svg
      meta_launch_url: https://immich.lab.omglolwtfbbq.com/auth/login?autoLaunch=1
      open_in_new_tab: true
