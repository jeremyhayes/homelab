version: 1

metadata:
  name: OIDC Grafana

entries:

  - model: authentik_providers_oauth2.oauth2provider
    id: grafana
    identifiers:
      name: Provider for Grafana
    attrs:
      authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
      invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
      client_id: !File /run/secrets/grafana-client-id
      client_secret: !File /run/secrets/grafana-client-secret
      redirect_uris:
        - matching_mode: strict
          url: https://grafana.lab.omglolwtfbbq.com/login/generic_oauth
      signing_key: !Find [authentik_crypto.certificatekeypair, [name, authentik Self-signed Certificate]]
      sub_mode: user_username
      access_token_validity: "minutes=5"
      property_mappings:
        - !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-openid]]
        - !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-email]]
        - !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-profile]]

  - model: authentik_core.application
    identifiers:
      slug: grafana
    attrs:
      name: Grafana
      provider: !KeyOf grafana
      group: Infrastructure
      icon: icons/grafana.svg
      meta_launch_url: https://grafana.lab.omglolwtfbbq.com/login/generic_oauth
      open_in_new_tab: true
